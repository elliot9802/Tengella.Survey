@model SurveyAnalysis

@{
    ViewData["Title"] = "Survey Analysis";
}

<div class="container mt-4">
    <h1 class="text-center">Survey Analysis for @Model.SurveyForm.Name</h1>

    <div class="row mb-4">
        <div class="col text-center">
            <h2>Total Responses: @Model.TotalResponses</h2>
        </div>
    </div>
    <div id="questions-container" data-total-responses='@Html.Raw(Json.Serialize(Model.QuestionAnalyses.ToDictionary(q => q.QuestionId, q => q.Question.Responses.Count)))' data-new-responses='@Html.Raw(Json.Serialize(Model.QuestionAnalyses.Select(q => new { q.QuestionId, q.Question.Responses }).ToDictionary(q => q.QuestionId, q => q.Responses.Select(r => r.TextResponse).ToList())))'>
        @foreach (var questionAnalysis in Model.QuestionAnalyses)
        {
            <div class="card mb-4 question-card">
                <div class="card-body">
                    <h3 class="card-title">Question: @questionAnalysis.Question.Text</h3>
                    <p>Total Responses: @questionAnalysis.TotalResponses</p>
                    <div class="question-content mt-3">
                        @if (questionAnalysis.Question.Type == "Radio")
                        {
                            <h4>Average Rating: @questionAnalysis.AverageRating</h4>
                            <h4>Options:</h4>
                            <ul class="list-group">
                                @foreach (var optionAnalysis in questionAnalysis.OptionAnalyses)
                                {
                                    <li class="list-group-item">
                                        @optionAnalysis.Option.Text: @optionAnalysis.ResponseCount responses
                                    </li>
                                }
                            </ul>
                            <a href="@Url.Action("QuestionTrendAnalysis", "SurveyAnalysis", new { id = questionAnalysis.QuestionId })" class="btn btn-primary mt-3">View Trends</a>

                            <div class="row mt-5">
                                <div class="col">
                                    <div class="ct-chart ct-golden-section" id="chart-@questionAnalysis.QuestionId"></div>
                                </div>
                            </div>
                            <script>
                                document.addEventListener('DOMContentLoaded', function () {
                                    new Chartist.Bar('#chart-@questionAnalysis.QuestionId', {
                                        labels: @Html.Raw(Json.Serialize(questionAnalysis.OptionAnalyses.Select(o => o.Option.Text).ToArray())),
                                        series: [
                                @Html.Raw(Json.Serialize(questionAnalysis.OptionAnalyses.Select(o => o.ResponseCount).ToArray()))
                                                                                                        ]
                                    });
                                });
                            </script>
                        }
                        else if (questionAnalysis.Question.Type == "Open")
                        {
                            <h4>Responses:</h4>
                            <ul class="list-group" id="responses-@questionAnalysis.QuestionId">
                                @foreach (var response in questionAnalysis.Question.Responses.Take(10))
                                {
                                    <li class="list-group-item">
                                        @response.TextResponse
                                    </li>
                                }
                            </ul>
                            @if (questionAnalysis.Question.Responses.Count > 10)
                            {
                                <i class="fas fa-chevron-down show-more-btn mt-3" data-question-id="@questionAnalysis.QuestionId"></i>
                                <i class="fas fa-chevron-up minimize-btn mt-3 d-none" data-question-id="@questionAnalysis.QuestionId"></i>
                            }
                            @* <a href="@Url.Action("QuestionTrendAnalysis", "SurveyAnalysis", new { id = questionAnalysis.QuestionId })" class="btn btn-primary mt-3">View Trends</a> *@
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="~/js/analysis.js"></script>
}
